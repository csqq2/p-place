<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>r/place-like Board</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #palette { display: flex; justify-content: center; margin: 10px; }
    .color {
      width: 24px; height: 24px; margin: 2px;
      border: 1px solid #000; cursor: pointer;
    }
    .selected { border: 3px solid red !important; }
    canvas { border: 1px solid black; cursor: crosshair; }
  </style>
</head>
<body>
  <h1>r/place-like Board</h1>
  <p>Cooldown: <span id="cooldown">0</span>s</p>
  <div id="palette"></div>
  <canvas id="board" width="512" height="512"></canvas>

  <script>
    const DEFAULT_WS_URL = "wss://pplace.onrender.com/ws";
    const WIDTH = 512, HEIGHT = 512;
    const PALETTE = [
      "#000000", "#FFFFFF", "#888888",
      "#F44336", "#E91E63", "#9C27B0", "#673AB7", "#3F51B5",
      "#2196F3", "#03A9F4", "#00BCD4", "#009688", "#4CAF50",
      "#8BC34A", "#CDDC39", "#FFEB3B", "#FFC107", "#FF9800",
      "#FF5722", "#795548", "#9E9E9E", "#607D8B"
    ];

    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    const cooldownEl = document.getElementById("cooldown");
    let currentColor = PALETTE[0];
    let cooldown = 0;

    // palette setup
    const paletteDiv = document.getElementById("palette");
    PALETTE.forEach(c => {
      const div = document.createElement("div");
      div.className = "color";
      div.style.background = c;
      div.onclick = () => {
        currentColor = c;
        document.querySelectorAll(".color").forEach(el => el.classList.remove("selected"));
        div.classList.add("selected");
      };
      paletteDiv.appendChild(div);
    });
    paletteDiv.firstChild.classList.add("selected");

    // websocket
    const ws = new WebSocket(DEFAULT_WS_URL);
    ws.onopen = () => console.log("Connected");
    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (msg.type === "pixel") {
        drawPixel(msg.x, msg.y, msg.color);
      }
    };

    function drawPixel(x, y, hex) {
      const rgb = hexToRgb(hex);
      const imageData = ctx.createImageData(1,1);
      imageData.data[0] = rgb.r;
      imageData.data[1] = rgb.g;
      imageData.data[2] = rgb.b;
      imageData.data[3] = 255;
      ctx.putImageData(imageData, x, y);
    }

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return { r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255 };
    }

    canvas.addEventListener("click", e => {
      if (cooldown > 0) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor(e.clientX - rect.left);
      const y = Math.floor(e.clientY - rect.top);
      ws.send(JSON.stringify({ type:"set", x, y, color: currentColor }));
      cooldown = 5;
      cooldownEl.textContent = cooldown;
    });

    setInterval(() => {
      if (cooldown > 0) {
        cooldown--;
        cooldownEl.textContent = cooldown;
      }
    }, 1000);
  </script>
</body>
</html>
